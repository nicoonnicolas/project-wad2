<!doctype html>
<html lang="en">

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<script type="text/javascript" src="vue.js"></script>

	<link type="text/css" rel="stylesheet" href="scss/custom.css" />

	<!-- Load Vue followed by BootstrapVue -->
	<script src="https://unpkg.com/vue@latest/dist/vue.min.js"></script>
	<script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>

	<!-- Load the following for BootstrapVueIcons support -->
	<script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue-icons.min.js"></script>

	<!-- Firebase Source Files-->
	<script src="https://www.gstatic.com/firebasejs/8.3.0/firebase-app.js"></script>
	<!-- <script src="https://www.gstatic.com/firebasejs/8.3.0/firebase-analytics.js"></script> -->
	<script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-database.js"></script>
	<!-- <script src="https://www.gstatic.com/firebasejs/8.2.6/firebase-auth.js"></script> -->


	<!-- Date formatter: refer to https://github.com/datejs/Datejs for documentation -->
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/datejs/1.0/date.min.js"
		integrity="sha512-/n/dTQBO8lHzqqgAQvy0ukBQ0qLmGzxKhn8xKrz4cn7XJkZzy+fAtzjnOQd5w55h4k1kUC+8oIe6WmrGUYwODA=="
		crossorigin="anonymous"></script> -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
		integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
		crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-recur/1.0.7/moment-recur.min.js"></script>

	<script>moment().format();</script>

	<script
		src="https://www.paypal.com/sdk/js?currency=SGD&client-id=ARqV8Dq2UHOZV1yd0pSTUq2O0mt-zXjTO4iUafSZoC52Cv2fm8_jEvuev9c5o_MRPl1CMFckaj1Z5ipe"></script>

	<script>
		// Initialize Firebase
		var firebaseConfig = {
			apiKey: "AIzaSyDhBjd0INJO6MpP_SX3vJJFRQzgrc1yCbc",
			authDomain: "just-clover-301402.firebaseapp.com",
			databaseURL:
				"https://just-clover-301402-default-rtdb.firebaseio.com",
			projectId: "just-clover-301402",
			storageBucket: "just-clover-301402.appspot.com",
			messagingSenderId: "999591178620",
			appId: "1:999591178620:web:5ed2ca489e1fee2836b4f9",
			measurementId: "G-4M8XE224JF",
		}
		firebase.initializeApp(firebaseConfig);
		const AppDB = firebase.database();

	</script>

	<link rel="stylesheet" href="scss/custom.css" />
</head>

<body>
	<div id='app'>
		<!-- --------------------NAVBAR------------------------- -->

		<div>
			<b-navbar toggleable="lg" type="light" variant="faded">
				<b-navbar-brand href="index.html">
					<b-img src="images\app\logo.JPG" height="70px" width="70px"></b-img> Huddle
				</b-navbar-brand>

				<b-navbar-toggle target="nav-collapse"></b-navbar-toggle>

				<b-collapse id="nav-collapse" is-nav>
					<b-navbar-nav>
					</b-navbar-nav>

					<!-- Right aligned nav items -->
					<b-navbar-nav class="ml-auto">
						<b-nav-item href="index.html">Find a Space</b-nav-item>
						<b-nav-item href="bookings.html">My Bookings</b-nav-item>
						<!-- <b-nav-form>
                        <b-form-input size="sm" class="mr-sm-2" placeholder="Search"></b-form-input>
                        <b-button size="sm" class="my-2 my-sm-0" type="submit">Search</b-button>
                      </b-nav-form> -->


						<b-nav-item-dropdown right>
							<!-- Using 'button-content' slot -->
							<template #button-content>
								<em>User</em>
							</template>
							<b-dropdown-item href="#">Profile</b-dropdown-item>
							<b-dropdown-item href="#">Sign Out</b-dropdown-item>
						</b-nav-item-dropdown>
					</b-navbar-nav>
				</b-collapse>
			</b-navbar>
		</div>


		<div class="container-fluid">
			<div class="row">
				<div class="col-md m-5">
					<!-- <b-table stacked :items="items" striped='false'></b-table> -->

					<img class="img-fluid" src="./images/listing/1000/image1.png">
					<div class="my-4">
						<h3 class="display-4">{{name}}</h3>
						<h4 class="mt-3">{{address}}</h4>
						<p class="mt-3">Date: {{booking.startDate}} to {{booking.endDate}}</p>
						<a href="#">Edit Booking</a>
					</div>
					<!-- <div class="mt-5 clearfix">
						<h4 class="float-left">{{ booking.workspaceType }}</h4>
						<h5 class="float-right">${{ booking.bookingPrice }}/day</h5>
					</div>
					<h6 class="mt-3">{{ booking.address}} ##unit number</h6>
					<div class="mt-4">

						<a href="#">Change Unit</a>
					</div>
					<div>
						<h6 class="mt-4">From {{ booking.startDate }} - {{booking.endDate}}</h6>
					</div> -->
				</div>
				<div class="col-md m-5">
					<b-jumbotron class="mt-5" header="" lead="">
						<h2>Order Details</h2>
						<!-- <div class="clearfix">
							<h4 class="float-left">{{ booking.workspaceType }}</h4>
							<h5 class="float-right">${{ booking.bookingPrice }}/day</h5>
						</div>
						<div class="mt-1 clearfix">
							<h6 class="float-left">No. of Days</h6>
							<h6 class="float-right">x5</h6>
						</div>
						<hr>
						<div class="clearfix">
							<h4 class="float-left">Total Payment</h4>
							<h5 class="float-right">{{booking.totalPrice}}</h5>
						</div> -->

						<b-table borderless thead-class="d-none" :items="table"></b-table>
						<div class="mt-2" ref='paypal'></div>
					</b-jumbotron>

				</div>
			</div>
		</div>

	</div>


	<script>

		var vm = new Vue({
			el: '#app',

			data: {
				paidFor: true,
				name: '',
				address: '',
				area: '',
				// capacity: '',
				days: '',
				type: '',
				price: '',
				booking: {
					bookingPrice: 1,
					address: '123 Victoria Road',
					startDate: "03-23-2021",
					endDate: "04-29-2021",
					workspaceType: 'Single',
					totalPrice: 4,
					customer_id: null,
					listing_id: 1000,
					is_recurring: null,
					recurring_days: ['Tuesday'],
					dates: []
				},
				table: [
					{ order: 'Space', cost: this.work },
					{ order: 'Booking Days', cost: this.days },
					{ order: 'Service Charge', cost: '10%' },
					{ order: 'Total', cost: this.price },
				]
			},
			created() {
				let uri = window.location.search.substring(1);
				if (uri !== '') {

					let params = new URLSearchParams(uri);
					// console.log(this.booking)
					this.booking.bookingPrice = params.get("booking_price")
					this.booking.customer_id = params.get("customer_id")
					this.booking.listing_id = params.get("listing_id")
					this.booking.startDate = params.get("start_date")
					this.booking.endDate = params.get("end_date")
					this.booking.is_recurring = params.get("is_recurring")
					this.recurring_days = params.get("recurring_days")
					// http://localhost/project-wad2/payment.html?booking_price=5&customer_id=2&listing_id=10&start_date=17-03-20&end_date=20-03-20&is_recurring=true
					// console.log(this.booking)
				}
				this.processBooking(this.booking.startDate, this.booking.endDate, this.recurring_days)
				this.displayListingDetails(this.booking.listing_id);
				// console.log(this.recurring_days[0])


			},
			updated() {
			},
			mounted: function () {
				window.paypal
					.Buttons({
						createOrder: (data, actions) => {
							return actions.order.create({
								purchase_units: [
									{
										description: 'test',
										amount: {
											currency_code: 'SGD',
											value: this.test.totalPrice
										}
									}
								]
							});
						},
						onApprove: async (data, actions) => {
							// email: sarahwoon@gmail.com
							// pw: 2G?yV/pI
							this.addBooking()
							window.location.replace("http://localhost/project-wad2/paid.html");
							// const order = await actions.order.capture();
							// console.log(order);
						},
						onError: err => {
							console.log(err);
						}
					})
					.render(this.$refs.paypal);
			},
			methods: {
				displayListingDetails: function (id) {
					var listing = firebase.database().ref("listing/" + id);
					listing.on("value", (snapshot) => {
						if (snapshot.val() != null) {
							details = snapshot.val();

							this.name = details.name
							this.address = details.address + " " + details.postal + " #" + details.unit
							this.area = details.area
							this.capacity = details.capacity
							this.type = details.type
							this.price = details.price
							// this.loaded = true;
						}

					});
				},
				processBooking(start_date, end_date, reccuring_arr) {
					var start = moment(start_date, "MM-DD-YYYY")
					var end = moment(end_date, "MM-DD-YYYY")
					this.days = end.diff(start, 'days')
					var weeks= end.diff(start, 'weeks')
					
					if (this.booking.is_recurring == true) {
						let firstDay = start_date
						console.log(this.getNextEvents(firstDay, weeks, 'Tuesday', 1));

					}
					this.booking.bookingPrice = this.days * this.price
				},
				addBooking() {
					var bookingRef = AppDB.ref('booking/')
					bookingRef.push(this.booking)
				},
				getNextEvents(startDate, numEvents, dayOfWeek, weekIndex) {
					var events = moment(startDate)
						.recur()
						.every(dayOfWeek)
						.daysOfWeek()
						.every(weekIndex)
						
					return events.next(numEvents, "YYYY-MM-DD");
				}
			}
		}
		)

	</script>

	<style lang="scss">
		/* .btngrp--margin {
            margin-left: 200px;
        }

        .btngrp--nomargin {
            margin-left: 0px;
        } */
		.navbar-toggle-color {
			background-color: grey;
		}
	</style>

</body>

</html>