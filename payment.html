<!doctype html>
<html lang="en">

<head>
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<script type="text/javascript" src="vue.js"></script>

	<link type="text/css" rel="stylesheet" href="scss/custom.css" />

	<!-- Load Vue followed by BootstrapVue -->
	<script src="https://unpkg.com/vue@latest/dist/vue.min.js"></script>
	<script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>

	<!-- Load the following for BootstrapVueIcons support -->
	<script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue-icons.min.js"></script>

	<!-- Firebase Source Files-->
	<script src="https://www.gstatic.com/firebasejs/8.3.0/firebase-app.js"></script>
	<!-- <script src="https://www.gstatic.com/firebasejs/8.3.0/firebase-analytics.js"></script> -->
	<script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-database.js"></script>
	<!-- <script src="https://www.gstatic.com/firebasejs/8.2.6/firebase-auth.js"></script> -->


	<!-- Date formatter: refer to https://github.com/datejs/Datejs for documentation -->
	<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/datejs/1.0/date.min.js"
		integrity="sha512-/n/dTQBO8lHzqqgAQvy0ukBQ0qLmGzxKhn8xKrz4cn7XJkZzy+fAtzjnOQd5w55h4k1kUC+8oIe6WmrGUYwODA=="
		crossorigin="anonymous"></script> -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"
		integrity="sha512-qTXRIMyZIFb8iQcfjXWCO8+M5Tbc38Qi5WzdPOYZHIlZpzBHG3L3by84BBBOiRGiEb7KKtAOAs5qYdUiZiQNNQ=="
		crossorigin="anonymous"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment-recur/1.0.7/moment-recur.min.js"></script>

	<script>moment().format();</script>

	<script
		src="https://www.paypal.com/sdk/js?currency=SGD&client-id=ARqV8Dq2UHOZV1yd0pSTUq2O0mt-zXjTO4iUafSZoC52Cv2fm8_jEvuev9c5o_MRPl1CMFckaj1Z5ipe"></script>

	<script>
		// Initialize Firebase
		var firebaseConfig = {
			apiKey: "AIzaSyDhBjd0INJO6MpP_SX3vJJFRQzgrc1yCbc",
			authDomain: "just-clover-301402.firebaseapp.com",
			databaseURL:
				"https://just-clover-301402-default-rtdb.firebaseio.com",
			projectId: "just-clover-301402",
			storageBucket: "just-clover-301402.appspot.com",
			messagingSenderId: "999591178620",
			appId: "1:999591178620:web:5ed2ca489e1fee2836b4f9",
			measurementId: "G-4M8XE224JF",
		}
		firebase.initializeApp(firebaseConfig);
		const AppDB = firebase.database();

	</script>
	<script>
		var user_id = sessionStorage.getItem('userId')
	</script>

	<link rel="stylesheet" href="scss/custom.css" />
</head>

<!-- http://localhost/project-wad2/payment.html?booking_price=5&customer_id=2&listing_id=10&start_date=2021-03-17&end_date=2021-03-20&is_recurring=true  -->


<body>
	<div id='app'>
		<!-- --------------------NAVBAR------------------------- -->

		<div>
			<b-navbar toggleable="sm" type="light" variant="faded">
				<b-navbar-brand href="index.html">
					<b-img src="images\app\logo.JPG" height="70px" width="70px"></b-img> Huddle
				</b-navbar-brand>

				<b-navbar-toggle target="nav-collapse"></b-navbar-toggle>

				<b-collapse id="nav-collapse" is-nav>
					<b-navbar-nav>
					</b-navbar-nav>

					<!-- Right aligned nav items -->
					<b-navbar-nav class="ml-auto">
						<b-nav-item href="index.html">Find a Space</b-nav-item>
						<b-nav-item href="bookings.html">My Bookings</b-nav-item>
						<!-- <b-nav-form>
                        <b-form-input size="sm" class="mr-sm-2" placeholder="Search"></b-form-input>
                        <b-button size="sm" class="my-2 my-sm-0" type="submit">Search</b-button>
                      </b-nav-form> -->


						<b-nav-item-dropdown right>
							<!-- Using 'button-content' slot -->
							<template #button-content>
								<em>User</em>
							</template>
							<b-dropdown-item href="#">Profile</b-dropdown-item>
							<b-dropdown-item href="#">Sign Out</b-dropdown-item>
						</b-nav-item-dropdown>
					</b-navbar-nav>
				</b-collapse>
			</b-navbar>
		</div>


		<div class="container-fluid">
			<b-row>
				<b-col md class="m-5">
					<img class="img-fluid" :src="image">
					<div class="my-4">
						<h3>{{name}}</h3>
						<h5 class="mt-3">{{address}}</h5>
					</div>
					<!-- <div class="d-flex justify-content-between">
						<div>
							<p class="text-right">Booking Period: {{booking.startDate}} to {{booking.endDate}}</p>
						</div>
						<div><a href="">Edit Booking</a></div>
					</div> -->
					<template v-if="show">
					<b-card-group deck>
						<b-card header="Your Booked Dates">
								<b-list-group>
									<!-- class="justify-content-between"  -->
									<b-list-group-item v-for="date in booking.dates"> 
										<div>{{date}}</div>
										<!-- <div>
											<b-icon icon="trash" variant="danger"></b-icon>
										</div> -->
									</b-list-group-item>
								</b-list-group>
							</b-card>
						</b-card-group>
					</template>
					<div v-else>
						<p>Booking Period: {{booking.startDate}} to {{booking.endDate}}</p>
					</div>
				</b-col>
				<b-col md align-self="center" class="m-5">
					<b-jumbotron class="mt-5">
						<h2>Order Details</h2>
						<b-table borderless thead-class="d-none" :items="table"></b-table>
						<div class="mt-2" ref='paypal'></div>
					</b-jumbotron>

				</b-col>
			</b-row>
		</div>

	</div>

	<script>
		var vm = new Vue({
			el: '#app',
			data: {
				paidFor: true,
				name: '',
				address: '',
				days: '',
				price: 0,
				type: '',
				load: false,
				is_recurring: false,
				show: false,
				booking: {
					startDate: "",
					endDate: "",
					totalPrice: 0,
					user: '',
					listing_id: '',
					dates: [],
					recurring_days: ""
				},

			},
			computed: {
				table: function () {
					days = this.days + ' days'
					total_price = this.days * this.price * 0.90
					price_per_day = "SGD " + this.price
					var total = "SGD " + (Math.round((total_price + Number.EPSILON) * 100) / 100)
					this.booking["totalPrice"] = total_price.toFixed(2);
					var table = [
						{ order: 'Space', cost: this.type },
						{ order: 'Price per Day', cost: price_per_day },
						{ order: 'Booking Days', cost: days },
						{ order: 'Service Charge', cost: '10%' },
						{ order: 'Total', cost: total },
					]
					return table
				},
				image: function () {
					url = 'images/listing/' + this.booking.listing_id + "/image1.png"
					return url
				}
			},
			created() {
				let uri = window.location.search
				let params = new URLSearchParams(uri);

				this.booking.user = params.get("user")
				// user = user_id
				this.booking.listing_id = params.get("listing_id")
				this.booking.startDate = params.get("start_date")
				this.booking.endDate = params.get("end_date")
				this.is_recurring = params.get("is_recurring")
				if (params.get("recurring_days") !== null){
					this.booking.recurring_days = params.get("recurring_days").split(',')
				}



				this.getListingDetails(this.booking.listing_id)
				this.processBooking(this.booking.startDate, this.booking.endDate, this.recurring_days)
			},
			updated() {
			},
			mounted: function () {
				// email: sarahwoon@gmail.com
				// pw: 2G?yV/pI
				window.paypal
					.Buttons({
						createOrder: (data, actions) => {
							return actions.order.create({
								purchase_units: [
									{
										description: 'Space Booking',
										amount: {
											currency_code: 'SGD',
											value: this.booking.totalPrice
										}
									}
								]
							});
						},
						onApprove: async (data, actions) => {
							// email: sarahwoon@gmail.com
							// pw: 2G?yV/pI
							this.addBooking()
							window.location.replace("http://localhost/project-wad2/paid.html");
						},
						onError: err => {
							console.log(err);
						}
					})
					.render(this.$refs.paypal);
			},
			methods: {
				getListingDetails: function (id) {
					var listing = AppDB.ref("listing/" + id);
					listing.on("value", (snapshot) => {
						if (snapshot.val() != null) {
							details = snapshot.val();
							this.name = details.name
							this.address = details.address + " " + details.postal + " #" + details.unit
							this.type = details.type
							this.price = parseFloat(details.price)
							this.load = true
						}
					});
				},
				processBooking(start_date, end_date, reccuring_arr) {

					start = moment(start_date, "YYYY-MM-DD")
					end = moment(end_date, "YYYY-MM-DD")
					
					if (this.is_recurring === 'true') {
						this.show = true
						weeks = end.diff(start, 'weeks')
						recurring_days = this.booking.recurring_days
						this.booking.dates = this.getNextEvents(start_date, end_date, weeks, recurring_days, 1)
						this.days = this.booking.dates.length
					}
					else {
						this.days = parseInt(end.diff(start, 'days')) + 1
					}
				},
				addBooking() {
					var bookingRef = AppDB.ref('booking/')
					bookingRef.push(this.booking)
				},
				getNextEvents(startDate, end, numEvents, recurring_days, weekIndex) {
					var events = moment().recur(startDate, end)
						.every(recurring_days) //Tues, Wed
						.daysOfWeek() // Days of the week
						.every(weekIndex) //every X number weeks
					return events.all("dddd, MMMM DD");
				},
			}
		}
		)

	</script>

</body>

</html>