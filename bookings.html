<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <script type="text/javascript" src="vue.js"></script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.6.0/gsap.min.js"></script>

        <link type="text/css" rel="stylesheet" href="scss/custom.css" />

        <!-- Load Vue followed by BootstrapVue -->
        <script src="https://unpkg.com/vue@latest/dist/vue.min.js"></script>
        <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.min.js"></script>

        <!-- Load the following for BootstrapVueIcons support -->
        <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue-icons.min.js"></script>

        <!-- Firebase Source Files-->
        <script src="https://www.gstatic.com/firebasejs/8.3.0/firebase-app.js"></script>
        <!-- <script src="https://www.gstatic.com/firebasejs/8.3.0/firebase-analytics.js"></script> -->
        <script src="https://www.gstatic.com/firebasejs/7.6.1/firebase-database.js"></script>
        <!-- <script src="https://www.gstatic.com/firebasejs/8.2.6/firebase-auth.js"></script> -->
        <script>
            // Initialize Firebase
            var firebaseConfig = {
                apiKey: "AIzaSyDhBjd0INJO6MpP_SX3vJJFRQzgrc1yCbc",
                authDomain: "just-clover-301402.firebaseapp.com",
                databaseURL:
                    "https://just-clover-301402-default-rtdb.firebaseio.com",
                projectId: "just-clover-301402",
                storageBucket: "just-clover-301402.appspot.com",
                messagingSenderId: "999591178620",
                appId: "1:999591178620:web:5ed2ca489e1fee2836b4f9",
                measurementId: "G-4M8XE224JF",
            }
            firebase.initializeApp(firebaseConfig);
                // firebase.analytics();
	    </script>

        <style>
            img {
                height:100px;
                width: auto;
            }
            #row {
                margin-bottom: 20px;
            }
        </style>
    </head>

    <body>
        <div id='app'>
            <!-- --------------------NAVBAR------------------------- -->
            <b-navbar toggleable="lg" type="light" variant="faded">
                <b-navbar-brand href="index.html">
                    <b-img src="images\app\logo.JPG" height="70px" width="70px"></b-img> Huddle
                </b-navbar-brand>
    
                <b-navbar-toggle target="nav-collapse"></b-navbar-toggle>
    
                <b-collapse id="nav-collapse" is-nav>
                    <b-navbar-nav>
                    </b-navbar-nav>
    
                    <!-- Right aligned nav items -->
                    <b-navbar-nav class="ml-auto">
                        <b-nav-item href="index.html" active>Find a Space</b-nav-item>
                        <b-nav-item href="bookings.html">My Bookings</b-nav-item>
                        <!-- <b-nav-form>
                        <b-form-input size="sm" class="mr-sm-2" placeholder="Search"></b-form-input>
                        <b-button size="sm" class="my-2 my-sm-0" type="submit">Search</b-button>
                        </b-nav-form> -->
    
    
                        <b-nav-item-dropdown right>
                            <!-- Using 'button-content' slot -->
                            <template #button-content>
                                <em>User</em>
                            </template>
                            <b-dropdown-item href="#">Profile</b-dropdown-item>
                            <b-dropdown-item href="#">Sign Out</b-dropdown-item>
                        </b-nav-item-dropdown>
                    </b-navbar-nav>
                </b-collapse>
            </b-navbar>
        </div>

        <script>
            // import ErrorHandler from "./ErrorHandler.vue";
    
            var vm = new Vue({
                el: '#app',
                // components: { ErrorHandler },
                // name: "NameOfComponent",
                data: {
                    btngrpMargin: false,
                    btngrpNoMargin: true,
                    listings: null
                },
                created: function () {
                    this.listings = "";
    
                    var listings = firebase.database().ref("listing/");
                    allListings = "";
                    listings.on("value", (snapshot) => {
                        allListings = snapshot.val();
                        this.listings = allListings;
    
                        this.loaded = true;
    
                    });
                },
                // computed: {
    
                // },
                methods: {
                    changeMargin: function () {
                        // if (this.btngrpNoMargin) {
                        //     this.btngrpNoMargin = false;
                        //     this.btngrpMargin = true;
                        // } else {
                        //     this.btngrpNoMargin = true;
                        //     this.btngrpMargin = false;
                        // }
                    },
                    getAllListings: function () {
                        var listings = firebase.database().ref("listing/");
                        allListings = "";
                        listings.on("value", (snapshot) => {
                            // console.log(snapshot.val());
                            allListings = snapshot.val();
                        });
                        return allListings;
                    },
                    displayListings: function () {
                        var allListings = this.getAllListings();
                        this.listings = allListings;
                        console.log(this.listings)
                    }
                },
    
            })
        </script>

        <!-- My Bookings -->
        <div id="bookings">
            <b-container v-if="bookings !== null">
                <b-row v-for="booking in finalBookings" id="row">
                    <b-col sm="1"></b-col>
                    <b-col sm="2">
                        <img :src=" 'images/listing/' + booking['image'] ">
                    </b-col>
                    <b-col>
                        <!-- launch getListing here to get listing details -->
                        Name: {{booking["name"]}}<br>
                        Address: {{booking["address"]}}<br>
                        Unit: {{booking["unit"]}}<br>
                        Date: {{booking["startDate"]}} to {{booking["endDate"]}} <br>
                        Price: ${{booking["totalPrice"]}}

                    </b-col>
                </b-row>
            </b-container>
            <div v-else>
                <h5 style="text-align: center;">You don't have any bookings yet!</h5>
            </div>
        </div>

        <script>
            var vm2 = new Vue ({
                el: "#bookings",
                data: {
                    bookings: null,
                    allListings: null,
                    finalBookings: null
                },
                mounted: function() {
                    this.userData();
                },
                // updated() {
                //         if (this.userData()) {
                //             getListing(this.number);
                //         }
                // },
                methods: {
                    userData: function() {
                        // Filters '/booking' object based on user ID, which can be found in /users. I think you will need to link up with Nicholas on how to get User ID! For now I just harded coded the User ID in .equalTo(), this is the only part you need to change in future
                        var bookings = firebase.database().ref("booking").orderByChild("user").equalTo("107797752277618949799").on("value", (snapshot) => {

                            // store snapshot.val() in your own variable

                            var foundBooking = [];
                            
                            for (j in snapshot.val()) {
                                var bookingName = j;
                                var obj = snapshot.val()[bookingName];

                                var startDate = obj.startDate;
                                var endDate = obj.endDate;
                                var totalPrice = obj.totalPrice;
                                var listing_id = obj.listing_id;

                                foundBooking.push({listing_id, startDate, endDate, totalPrice});
                            }

                            if(foundBooking.length > 0) {
                                // add all the extra info into bookings
                                this.bookings = foundBooking;

                                var finalBookings = [];

                                this.$nextTick(() => {
                                    this.getListing();
                                    for (b of this.bookings) {
                                        for (i of this.allListings) {
                                            if (b.listing_id === i.listing_id) {
                                                
                                                // b
                                                var startDate = b.startDate;
                                                var endDate = b.endDate;
                                                var totalPrice = b.totalPrice;

                                                // i
                                                var name = i.name;
                                                var address = i.address;
                                                var unit = i.unit;
                                                var postal = i.postal;
                                                var capacity = i.capacity;
                                                var image = i.image;
                                                
                                                finalBookings.push({name, address, unit, postal, capacity, image, startDate, endDate, totalPrice});
                                            }
                                        }
                                    }
                                    this.finalBookings = finalBookings;
                                })
                                
                            }
                            
                        })
                    },

                    getListing() {
                        if (this.bookings !== null) {

                            var listings = firebase.database().ref("listing").on("value", (snapshot) => {

                                var allListings = [];

                                for (i in snapshot.val()) {
                                    var listingNum = i;
                                    var obj = snapshot.val()[listingNum];

                                    var name = obj.name;
                                    var address = obj.address;
                                    var unit = obj.unit;
                                    var postal = obj.postal;
                                    var capacity = obj.capacity;
                                    var image = obj.images[0];

                                    allListings.push({listing_id: i, name, address, unit, postal, capacity, image});
                                }

                                this.allListings = allListings;
                                
                            })
                        }
                    },

                    // checkListingNum(listNum) {
                    //     var allListings = this.allListings;
                        
                    // }
                }
            })
        </script>
    </body>
</html>